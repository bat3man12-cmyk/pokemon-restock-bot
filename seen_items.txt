SEEN_FILE = "seen_items.txt"

def load_seen_items():
    if not os.path.exists(SEEN_FILE):
        return set()
    with open(SEEN_FILE, "r", encoding="utf-8") as f:
        return set(line.strip() for line in f)

def save_seen_items(seen):
    with open(SEEN_FILE, "w", encoding="utf-8") as f:
        for item in seen:
            f.write(item + "\n")
def run():
    seen_items = load_seen_items()
    new_seen = set(seen_items)  # copy

    for store, cfg in STORES.items():
        if cfg["coord"] != USER_COORD and not within_distance(cfg["coord"]):
            continue
        try:
            items = cfg["parser"](cfg["url"])
            if not items:
                continue

            # Only keep new items that havenâ€™t been seen
            new_items = [item for item in items if item not in seen_items]
            if not new_items:
                continue

            # Send Discord message
            message = f"STORE RESTOCK DETECTED: {store} ({USER_POSTCODE})\n\n"
            for item in new_items[:10]:
                message += f"- {item}\n"
                new_seen.add(item)  # mark as seen

            send_discord(message)

        except Exception as e:
            print(f"{store} error: {e}")

    save_seen_items(new_seen)
